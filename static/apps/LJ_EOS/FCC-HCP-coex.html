<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FCC-HCP Phase Coexistence for LJ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <link href='main.css' rel='stylesheet'>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.10.3/brython.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.10.3/brython_stdlib.js"></script>
    <script type='text/javascript' src='util.js'></script>
    <script src="https://cdn.plot.ly/plotly-2.11.1.min.js"></script>
    <script>
      function myUpdatePlot() {
        var xsets = document.getElementById("plotXDiff").checked ? "diff" : "single";
        var ysets = document.getElementById("plotYDiff").checked ? "diff" : "single";
        updatePlotCoex("fcc", "hcp", Infinity, Infinity, xsets, ysets);
      }
      window.addEventListener("load", function() {
        var plotModalEl = document.getElementById("plotModal");
        plotModalEl.addEventListener("show.bs.modal", myUpdatePlot);
      });
function clearAllRows() {
  var tbody = document.getElementById("coex-table");
  empty(tbody);
}
  
var copyText0 = "T,rho1,rho2,P,G,phi\n", copyText = "";
var allData = [];
var lastRow = null;
function addRow(T, props1, props2) {
  if (lastRow) {
    lastRow.className = "";
    lastRow = null;
  }
  var tbody = document.getElementById("coex-table");
  var row = makeElement("TR");
  props1.v2 = 1/(props1.rho*props1.rho);
  props2.v2 = 1/(props2.rho*props2.rho);
  props1.Y = (T/4)*Math.pow(props1.rho,-4);
  props2.Y = (T/4)*Math.pow(props2.rho,-4);
  allData.push({T: T, props1: props1, props2: props2});
  var v = [T, props1['rho'], props2['rho'], props1['P'], props1['G'], 'alpha' in props2 ? props2['alpha'] : 1];
  sortData();
  for (var i=0; i<v.length; i++) {
    makeElement("TD", row, {textContent: v[i]});
  }
  var allRows = tbody.rows;
  var success = false;
  for (var i=0; i<allRows.length; i++) {
    var iRow = allRows[i];
    var iP = Number(iRow.childNodes[3].textContent);
    if (iP > v[4]) {
      tbody.insertBefore(row, iRow);
      success = true;
      break;
    }
  }
  if (!success) tbody.appendChild(row);
  row.className = "table-success";
  lastRow = row;
  window.setTimeout(function() { row.className = ""; }, 500);
}
function setStage(s) {
  if (s==1) allData = [];
  document.getElementById("lowPbranch").style.display = s == 2 ? "inline" : "none";
}
function sortData() {
  allData.sort(function(a,b) {
    return a.props1['P'] - b.props1['P'];
  });
  copyText = "";
  for (var i=0; i<allData.length; i++) {
    var d = allData[i];
    copyText += d.T+","+d.props1.rho+","+d.props2.rho+","+d.props1.P+","+d.props1.G+","+('alpha' in d.props2 ? d.props2.alpha : 1)+"\n";
  }
}

function sortOutput() {
  var tbody = document.getElementById("coex-table");
  var rows = tbody.rows;
  var myrows = [];
  for (var i=0; i<rows.length; i++) {
    myrows.push(rows[i]);
  }
  myrows.sort(function(a,b) {
    var Pa = Number(a.childNodes[3].textContent);
    var Pb = Number(b.childNodes[3].textContent);
    return Pa - Pb;
  });
  empty(tbody);
  var lastP = -1;
  for (var i=0; i<myrows.length; i++) {
    var P = Number(myrows[i].childNodes[3].textContent);
    if (P == lastP) continue;
    lastP = P;
    tbody.appendChild(myrows[i]);
  }
  for (var i=0; i<myrows.length; i++) {
    tbody.appendChild(myrows[i]);
  }
}
window.addEventListener("load", phasesUpdated);
    </script>
  </head>
  <body onload='brython()'>
    <script type='text/python' src='LJ_EOS.py'></script>
    <script type='text/python' src='EOS_util.py'></script>
    <script type='text/python'>
      from browser import document, window, timer
      from browser.widgets.dialog import InfoDialog
      from LJ_EOS import getEOS, findCoexistence
      from EOS_util import optsForPhase

      eos1 = None
      eos2 = None
      myInterval = None
      iteration = dT = diT = Pguess = stage = Pg = Thigh = Plow = iT = 0
      doneiT = {}
      maxdiT = 27
      # stage 1: increase T from 0 while P decreases
      # stage 2: decrease Pguess at max T to look for low-P branch
      # stage 3: decrease T (with acceleration) along low-P branch from max toward P=0
      # stage 4: decrease T (with deceleration) along low-P branch from max to P~=0

      def doOneCoex():
        global stage, eos1, eos2, myInterval, diT, maxdiT, dT, Pguess, Pg, iT, Thigh, Plow, iteration, doneiT
        iteration += 1
        T = 0.01*iT/(1<<maxdiT)
        if stage == 2:
          Pgg = Pg
        else:
          Pgg = Pguess[iT]
        if iT in doneiT:
          (props1,props2) = doneiT[iT]
          addme = False
        else:
          props1, props2 = findCoexistence(T, eos1, eos2, Pgg, False)
          if stage != 2:
            # in stage 2, we vary Pguess and look for failure
            # we never repeat, so just don't store our failures
            doneiT[iT] = (props1,props2)
          addme = True
        if not 'rho' in props1 or (stage >= 3 and props1['P'] < 0):
          if stage == 1:
            diT -= 1
            if diT < 18: # dT ~= 0.00002
              # we failed to find more coex.  give up on high-P branch
              # first dial T back to where it was
              iT -= (1<<(diT+1))
              stage = 2
              doneiT = {}
              window.setStage(stage)
              iteration = 0
              # Pg is our new Pguess
              Pg = Plow - 0.1
              # in stage 2, we lower T looking for low-P branch of coexistence
              return
            # back up, retrace with smaller steps
            iT -= 8*(1<<diT)
            # doOneCoex will be called again and we'll do stage 1 with smaller steps
            return
          elif stage == 2:
            iT -= (1<<diT)
            # dial back T a bit more and look for low-P branch
            return
          elif stage >= 3:
            stage = 4
            diT -= 1
            if diT < 0:
              #window.sortOutput()
              window.setStage(5)
              stopUpdate()
              return
            iT += 8*(1<<diT)
            # back off a bit and continue searching for P~=0
            return
          else:
            # all done
            doStopUpdate()

        if stage == 1:
          if addme:
            window.addRow(T, props1, props2);

          if T > Thigh:
            Thigh = T
            Plow = props1['P']
          iT += (1<<diT)
          Pguess[iT] = props1['P']
        elif stage == 2:
          if props1['P'] < Plow - 0.1:
            # success!
            stage = 3
            window.setStage(stage)
            iteration = 0
            Pguess = {iT: Pg}
            return
          # P not low enough, maybe still high-P branch?
          Pg -= 0.5
        elif stage >= 3:
          if addme:
            window.addRow(T, props1, props2);

          if stage == 3 and (diT-18) < iteration/50 and iT%(1<<(diT+1)) == 0:
            # increment every 50 iterations or so
            diT += 1
          iT -= (1<<diT);
          Pguess[iT] = props1['P']

      def stopUpdate():
        global myInterval
        timer.clear_interval(myInterval)
        document["btnUpdate"].textContent = "Update"
        myInterval = None
        print("stopped")

      def update(ev):
        global stage, eos1, eos2, myInterval, dT, diT, maxdiT, Pguess, Plow, Thigh, iT, iteration
        if not myInterval == None:
          stopUpdate()
          return
        window.collapseParameters()
        document["btnUpdate"].textContent = "Stop"
        phase1 = document['phase1'].value
        opts = optsForPhase(phase1, document, None)
        if opts is None:
          return
        eos1 = getEOS(phase1, opts)
        phase2 = document['phase2'].value
        if phase1 == phase2:
          InfoDialog("Trouble", f"The two phases must be different")
          return
        opts = optsForPhase(phase2, document, None)
        if opts is None:
          return
        eos2 = getEOS(phase2, opts)
        stage = 1
        window.setStage(stage)
        dT = 0.01
        diT = maxdiT
        Pguess = {0: 800}
        Plow = 800
        Thigh = 0
        output = {}
        iT = 0
        Pg = 0
        iteration = 0
        window.clearAllRows()
        window.copyText = []
        myInterval = timer.set_interval(doOneCoex, 0)

      document["btnUpdate"].bind("click", update)
    </script>
    <div class='container'>
      <h1>FCC-HCP Phase Coexistence for LJ</h1>
      <div id='parametersDiv' class='card mb-4'>
        <div id='headingParameters' class='card-header' role='tab'>
          <h2 class='h5 mb-0'>Parameters</a></h2>
      </div>
      <div class='show' aria-labelledby='headingParameters'>
        <div class='card-body'>
          <div class='row'>
            <div class='col-auto px-4'>
              <div class='row g-3 py-1 align-items-center'>
                <div class='col-auto'>
                  <label for='rc' class='col-form-label'>Phase 1</label>
                </div>
                <div class='col-auto'>
                  <select class='form-select' id='phase1' onchange='phasesUpdated()'>
                    <option value='fcc' selected>FCC</option>
                  </select>
                </div>
              </div>
              <div class='row g-3 py-1 align-items-center'>
                <div class='col-auto'>
                  <label for='rc' class='col-form-label'>Phase 2</label>
                </div>
                <div class='col-auto'>
                  <select class='form-select' id='phase2' onchange='phasesUpdated()'>
                    <option value='hcp' selected>HCP</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class='row g-3 py-1 align-items-center'>
            <div class='col-auto'>
              <button id='btnUpdate' class='btn btn-sm btn-primary' type='button'>Trace coexistence</button>
            </div>
          </div>
        </div>
      </div>
    </div>

      <div id='parametersDiv-hcp' class='card mb-4'>
        <div id='headingParameters-hcp' class='card-header' role='tab'>
          <h2 class='h5 mb-0'><a role='button' data-bs-toggle='collapse' href='#collapseparametersDiv-hcp' aria-expanded='true' aria-controls='colapseparametersDiv-hcp'>HCP Parameters</a></h2>
        </div>
        <div id='collapseparametersDiv-hcp' class='collapse show' role='tabpanel' aria-labelledby='headingParameters-hcp'>
          <div class='card-body'>
            <div class='row'>
              <div class='col-auto px-4'>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto'>
                    <label for='inputEOS-hcp' class='col-form-label'>EOS</label>
                  </div>
                  <div class='col-auto'>
                    <select class='form-select' id='inputEOS-hcp'>
                      <option value='Schultz' selected>Schultz</option>
                      <option value='Adidharma'>Adidharma</option>
                    </select>
                  </div>
                </div>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto' class=form-check'>
                    <input class='form-check-input' type='checkbox' value='' id='checkLat-hcp'>
                    <label class='form-check-label' for='checkLat-hcp'>lattice properties</label>
                  </div>
                </div>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto' class=form-check'>
                    <input class='form-check-input' type='checkbox' value='' id='checkHarmonic-hcp'>
                    <label class='form-check-label' for='checkHarmonic-hcp'>lattice+harmonic properties</label>
                  </div>
                </div>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto' class=form-check'>
                    <input class='form-check-input' type='checkbox' value='' id='checkAlpha'>
                    <label class='form-check-label' for='checkAlpha'>impose &alpha;=1</label>
                  </div>
                </div>
              </div>
              <div class='col-auto px-4'>
                <div class='row g-3 py-1 align-items-center'>
              <div class='col-auto'>
                <label for='inputNh' class='col-form-label'># of atoms</label>
              </div>
              <div class='col-auto'>
                <select class='form-select' id='inputNh'>
                  <option value='0' selected>&infin;</option>
                  <option value='4096'>4096</option>
                  <option value='1728'>1728</option>
                  <option value='1200'>1200</option>
                  <option value='1000'>1000</option>
                  <option value='512'>512</option>
                </select>
              </div>
            </div>
            <div class='row g-3 py-1 align-items-center'>
              <div class='col-auto'>
                <label for='rc-hcp' class='col-form-label'>cutoff</label>
              </div>
              <div class='col-auto'>
                <select class='form-select' id='inputRc-hcp'>
                  <option value='0' selected>&infin;</option>
                  <option value='11'>11</option>
                  <option value='9'>9</option>
                  <option value='7.5'>7.5</option>
                  <option value='6'>6</option>
                  <option value='5'>5</option>
                  <option value='4'>4</option>
                  <option value='3.5'>3.5</option>
                  <option value='3'>3</option>
                </select>
              </div>
            </div>
            <div class='row g-3 py-1 align-items-center'>
              <div class='col-auto' class=form-check'>
                <input class='form-check-input' type='checkbox' value='' id='checkNrcc-hcp'>
                <label class='form-check-label' for='checkNrcc-hcp'>apply only to anharmonic</label>
              </div>
            </div>
            <div class='row g-3 py-1 align-items-center'>
              <div class='col-auto' class=form-check'>
                <input class='form-check-input' type='checkbox' value='' id='checkLRC-hcp'>
                <label class='form-check-label' for='checkLRC-hcp'>include LRC</label>
              </div>
            </div>
          </div>
        </div>
          </div>
        </div>
      </div>
      <div id='parametersDiv-fcc' class='card mb-4'>
        <div id='headingParameters-fcc' class='card-header' role='tab'>
          <h2 class='h5 mb-0'><a role='button' data-bs-toggle='collapse' href='#collapseparametersDiv-fcc' aria-expanded='true' aria-controls='colapseparametersDiv-fcc'>FCC Parameters</a></h2>
        </div>
        <div id='collapseparametersDiv-fcc' class='collapse show' role='tabpanel' aria-labelledby='headingParameters-fcc'>
          <div class='card-body'>
            <div class='row'>
              <div class='col-auto px-4'>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto'>
                    <label for='inputEOS-fcc' class='col-form-label'>EOS</label>
                  </div>
                  <div class='col-auto'>
                    <select class='form-select' id='inputEOS-fcc'>
                      <option value='Schultz' selected>Schultz</option>
                      <option value='Adidharma'>Adidharma</option>
                      <option value='dePablo'>de Pablo</option>
                      <option value='vdh'>van der Hoef</option>
                    </select>
                  </div>
                </div>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto' class=form-check'>
                    <input class='form-check-input' type='checkbox' value='' id='checkLat-fcc'>
                    <label class='form-check-label' for='checkLat-fcc'>lattice properties</label>
                  </div>
                </div>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto' class=form-check'>
                    <input class='form-check-input' type='checkbox' value='' id='checkHarmonic-fcc'>
                    <label class='form-check-label' for='checkHarmonic-fcc'>lattice+harmonic properties</label>
                  </div>
                </div>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto' class=form-check'>
                    <input class='form-check-input' type='checkbox' value='' id='checkVac-fcc'>
                    <label class='form-check-label' for='checkVac-fcc'>include vacancies</label>
                  </div>
                </div>
              </div>
              <div class='col-auto px-4'>
                <div class='row g-3 py-1 align-items-center'>
              <div class='col-auto'>
                <label for='inputNf' class='col-form-label'># of atoms</label>
              </div>
              <div class='col-auto'>
                <select class='form-select' id='inputNf'>
                  <option value='0' selected>&infin;</option>
                  <option value='4000'>4000</option>
                  <option value='2048'>2048</option>
                  <option value='864'>864</option>
                  <option value='500'>500</option>
                  <option value='256'>256</option>
                </select>
              </div>
            </div>
            <div class='row g-3 py-1 align-items-center'>
              <div class='col-auto'>
                <label for='rc-fcc' class='col-form-label'>cutoff</label>
              </div>
              <div class='col-auto'>
                <select class='form-select' id='inputRc-fcc'>
                  <option value='0' selected>&infin;</option>
                  <option value='11'>11</option>
                  <option value='9'>9</option>
                  <option value='7.5'>7.5</option>
                  <option value='6'>6</option>
                  <option value='5'>5</option>
                  <option value='4'>4</option>
                  <option value='3.5'>3.5</option>
                  <option value='3'>3</option>
                </select>
              </div>
            </div>
            <div class='row g-3 py-1 align-items-center'>
              <div class='col-auto' class=form-check'>
                <input class='form-check-input' type='checkbox' value='' id='checkNrcc-fcc'>
                <label class='form-check-label' for='checkNrcc-fcc'>apply only to anharmonic</label>
              </div>
            </div>
            <div class='row g-3 py-1 align-items-center'>
              <div class='col-auto' class=form-check'>
                <input class='form-check-input' type='checkbox' value='' id='checkLRC-fcc'>
                <label class='form-check-label' for='checkLRC-fcc'>include LRC</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

    <div id='resultsDiv' class='card'>
      <div id='headingResults' class='card-header' role='tab'>
        <h2 class='h5 mb-0' style='float: left'>Results <span id='lowPbranch' style='display: none;'>(finding low-P branch)</span></h2>
        <button class='btn btn-info btn-sm' style='float: right' onclick='copyToClipboard(copyText)'>Copy</button>
        <button class='btn btn-info btn-sm' style='margin-right: 1rem; float: right' id='plotBtn' data-bs-toggle="modal" data-bs-target="#plotModal">Plot</button>
    </div>
    <div class='show' aria-labelledby='headingResults'>
      <div class='card-body'>
        <table class='table table-sm'>
          <thead><tr><th>T</th><th>&rho;1</th><th>&rho;2</th><th>P</th><th>G</th><th>&alpha;</th></tr></thead>
          <tbody id='coex-table'></tbody>
        </table>
      </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="plotModal" tabindex="-1" aria-labelledby="plotModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="plotModalLabel">Plot</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="plotDiv" style="width:100%;height:500px;"></div>
            <div class='row'>
              <div class='col-auto px-4'>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto'>
                    <label for='inputXprop' class='col-form-label'>X:</label>
                  </div>
                  <div class='col-auto'>
                    <select class='form-select' id='inputXprop' onchange='myUpdatePlot()'>
                      <option value='T'>T</option>
                      <option value='rho' selected>&rho;</option>
                      <option value='P'>P</option>
                      <option value='U'>U</option>
                      <option value='A'>A</option>
                      <option value='G'>G</option>
                      <option value='Z'>Z</option>
                      <option value='Cv'>Cv</option>
                      <option value='phi'>&phi;</option>
                      <option value='alpha'>&alpha;</option>
                      <option value='v2'>v2</option>
                      <option value='Y'>Y</option>
                      <option value='H'>H</option>
                      <option value='S'>S</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class='col-auto px-4'>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto'>
                    <label for='inputYprop' class='col-form-label'>Y:</label>
                  </div>
                  <div class='col-auto'>
                    <select class='form-select' id='inputYprop' onchange='myUpdatePlot()'>
                      <option value='T'>T</option>
                      <option value='rho'>&rho;</option>
                      <option value='P' selected>P</option>
                      <option value='U'>U</option>
                      <option value='A'>A</option>
                      <option value='G'>G</option>
                      <option value='Z'>Z</option>
                      <option value='Cv'>Cv</option>
                      <option value='phi'>&phi;</option>
                      <option value='alpha'>&alpha;</option>
                      <option value='v2'>v2</option>
                      <option value='Y'>Y</option>
                      <option value='H'>H</option>
                      <option value='S'>S</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class='col-auto px-4'>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto' class=form-check'>
                    <input class='form-check-input' type='checkbox' value='' id='plotXDiff' onchange='myUpdatePlot()'>
                    <label class='form-check-label' for='plotXDiff'>X diff</label>
                  </div>
                </div>
              </div>
              <div class='col-auto px-4'>
                <div class='row g-3 py-1 align-items-center'>
                  <div class='col-auto' class=form-check'>
                    <input class='form-check-input' type='checkbox' value='' id='plotYDiff' onchange='myUpdatePlot()'>
                    <label class='form-check-label' for='plotXDiff'>Y diff</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
